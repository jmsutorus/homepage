name: Release
on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write # for checkout
  issues: write # to be able to comment on released issues
  pull-requests: write # to be able to comment on released pull requests
  id-token: write # to enable use of OIDC for npm provenance

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: prod
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Firebase CLI
        run: npm install -g firebase-tools

      - name: Trigger Firebase App Hosting Rollout
        run: |
          echo "Triggering Firebase App Hosting deployment..."
          firebase apphosting:rollouts:create homepage --project homepage-7cfc8 --git-branch main --force

  release:
    name: Release
    needs: deploy
    runs-on: ubuntu-latest
    environment: prod
    if: always() && (github.event_name == 'pull_request' || needs.deploy.result == 'success')
    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
      id-token: write # to enable use of OIDC for npm provenance
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install dependencies
        run: npm clean-install

      - name: Configure Git User
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate Release (Dry-run on PR)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release --dry-run

      - name: Release (Create release commits on main)
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx semantic-release
          echo "Checking if release commits were created..."
          git log --oneline -5

      - name: Create and Push Release Branch
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "Creating Release_Branch from current state..."
          git checkout -b Release_Branch
          git log --oneline -5
          echo "Pushing Release_Branch..."
          git push origin Release_Branch
          echo "Checking diff between main and Release_Branch..."
          git fetch origin main
          git log origin/main..Release_Branch --oneline

      - name: Create Pull Request
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create --base main --head Release_Branch --title "chore(release): new release" --body "Automated release PR created by semantic-release workflow."

      - name: Enable Auto-Merge
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge Release_Branch --auto --merge --delete-branch
